# Technical Specification – Note Taking Web App

## 1. Overview

A web application where authenticated users can create, view, edit, delete, and publicly share rich-text notes. Notes are created with TipTap, stored as JSON in a SQLite database, and rendered in the browser with formatting.

### Core Features

- User authentication (sign up, login, logout) via better-auth
- Authenticated note management (CRUD)
- Rich text editor using TipTap with:
  - Bold, Italic
  - Heading levels (H1–H3) + normal text
  - Inline code + code blocks
  - Bullet lists
  - Horizontal rules
- Public sharing of notes via a public URL (toggle on/off)

### Tech

- Next.js (App Router) + Bun runtime
- TypeScript
- TailwindCSS
- SQLite via Bun's SQLite client with raw SQL

## 2. Architecture

### 2.1 High-Level Architecture

- **Frontend & Backend:** Next.js (App Router)
  - Server components for data fetching
  - Client components for TipTap editor and interactive UI
  - Route Handlers (`app/api/.../route.ts`) for JSON APIs
- **Runtime:** Bun (for dev & production)
- **Database:** Single SQLite file (e.g., `data/app.db`) accessed via Bun's SQLite client
- **Auth:** better-auth integrated into Next.js (middleware + server helpers)

### 2.2 Application Layers

**Presentation layer**

- Next.js pages and components
- TailwindCSS for styling
- TipTap editor component

**API layer**

- REST-like JSON endpoints for notes CRUD & sharing

**Data access layer**

- Raw SQL queries executed via Bun's SQLite client
- A small helper module for DB access

## 3. Functional Requirements

### 3.1 Authentication

Users can:

- Register (email + password, minimum validation)
- Log in / log out

Authentication state is accessible on server (for SSR) and on client (for protected UI).

Unauthenticated users:

- Can access public shared note URLs (read-only)
- Cannot access dashboard or personal notes

### 3.2 Notes Management (Authenticated)

**Create a new note:**

- Default title: "Untitled note"
- Default empty TipTap document

**View a list of own notes:**

- Show title, last updated at, shared status

**View a single note:**

- Load editor with stored TipTap JSON document

**Update note:**

- Change title
- Change content (TipTap JSON)
- Auto-update `updated_at`

**Delete note:**

- Hard delete

### 3.3 Note Sharing

Users can toggle note "public sharing":

**When enabled:**

- Note gets a unique public slug (e.g. `abcdef1234`)
- Accessible via `/p/{slug}` for anonymous users

**When disabled:**

- Public URL returns 404 / "Note not found"

**Public page rendering:**

- Reads note from DB by `public_slug`
- Shows title and content in read-only mode
- No editing or owner information necessary

## 4. Non-Functional Requirements

**Performance**

- Notes list & note view should load under ~300 ms for typical DB sizes

**Security**

- All note operations are scoped to authenticated user's `user_id`
- Public notes are read-only; no leaked private data in API responses

**Reliability**

- Graceful handling of DB errors

**Maintainability**

- Type-safe APIs and DB types
- Modularized DB and auth helpers

**UX**

- Simple, minimal UI with keyboard-friendly editor

## 5. Data Model & Database Schema (SQLite)

### 5.1 Database Setup with better-auth

**better-auth** manages authentication tables automatically using its built-in schema generation and migration system. The library uses [Kysely](https://kysely.dev/) under the hood for database operations.

#### Database Configuration

```typescript
// lib/auth.ts
import { betterAuth } from "better-auth";
import { Database } from "bun:sqlite";

export const auth = betterAuth({
  database: new Database("database.sqlite"),
  // ... other configuration
});
```

#### Schema Generation & Migration

Use the Better Auth CLI to generate and migrate your database schema:

```bash
# Generate schema based on your auth configuration
bun x @better-auth/cli@latest generate

# Apply migrations to your database
bun x @better-auth/cli@latest migrate
```

The CLI will automatically create and manage the following core authentication tables:

- **user** - Stores user account information (id, name, email, emailVerified, image, timestamps)
- **session** - Manages active user sessions (id, userId, token, expiresAt, ipAddress, userAgent, timestamps)
- **account** - Handles authentication providers and credentials (id, userId, accountId, providerId, tokens, password hash, timestamps)
- **verification** - Manages email verification and password reset tokens (id, identifier, value, expiresAt, timestamps)

**Note:** The exact schema structure is managed by better-auth. Always use the CLI for schema changes rather than manual SQL. For detailed schema information, refer to the [better-auth SQLite documentation](https://www.better-auth.com/docs/integrations/sqlite).

#### Performance Optimization (Experimental)

Enable database joins for improved performance (2-3x faster for endpoints like `/get-session`):

```typescript
export const auth = betterAuth({
  database: new Database("database.sqlite"),
  experimental: { joins: true }
});
```

### 5.2 Application Tables

#### notes

```sql
CREATE TABLE notes (
  id TEXT PRIMARY KEY,
  user_id TEXT NOT NULL,
  title TEXT NOT NULL,
  content_json TEXT NOT NULL,
  is_public INTEGER NOT NULL DEFAULT 0,
  public_slug TEXT UNIQUE,
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now')),
  FOREIGN KEY (user_id) REFERENCES user(id)
);
```

| Field        | Type    | Description                                               |
| ------------ | ------- | --------------------------------------------------------- |
| id           | TEXT    | Unique identifier for each note (primary key)             |
| user_id      | TEXT    | The ID of the note owner (foreign key to user.id)         |
| title        | TEXT    | Note title                                                |
| content_json | TEXT    | TipTap document stored as JSON string                     |
| is_public    | INTEGER | Whether the note is publicly accessible (0 or 1)          |
| public_slug  | TEXT    | Unique slug for public URL (null if not public)           |
| created_at   | TEXT    | Timestamp of when the note was created                    |
| updated_at   | TEXT    | Timestamp of when the note was last updated               |

#### Indexes for notes table

```sql
CREATE INDEX idx_notes_user_id ON notes(user_id);
CREATE INDEX idx_notes_public_slug ON notes(public_slug);
CREATE INDEX idx_notes_is_public ON notes(is_public);
```

## 6. Backend: DB & API Layer

### 6.1 Database Access Module

**File:** `lib/db.ts`

Initialize a shared Bun SQLite client for application data (notes). Authentication tables are managed automatically by better-auth.

**Example:**

```typescript
import { Database } from "bun:sqlite";

let db: Database | null = null;

export function getDb(): Database {
  if (!db) {
    db = new Database("database.sqlite");
  }
  return db;
}

// Optional utility wrappers
export function query<T>(sql: string, params?: any[]): T[] {
  return getDb().query(sql).all(params) as T[];
}

export function get<T>(sql: string, params?: any[]): T | undefined {
  return getDb().query(sql).get(params) as T | undefined;
}

export function run(sql: string, params?: any[]): void {
  getDb().query(sql).run(params);
}
```

**Note:** better-auth manages its own database connection and operations for authentication tables. Your application code only needs to interact with the `notes` table.

### 6.2 Note Repository Functions

**File:** `lib/notes.ts`

**TypeScript types:**

```typescript
export type Note = {
  id: string;
  userId: string;
  title: string;
  contentJson: string; // stringified TipTap doc
  isPublic: boolean;
  publicSlug: string | null;
  createdAt: string;
  updatedAt: string;
};
```

**Repository functions:**

- `createNote(userId: string, data: { title?: string; contentJson?: string }): Promise<Note>`
- `getNoteById(userId: string, noteId: string): Promise<Note | null>`
- `getNotesByUser(userId: string): Promise<Note[]>`
- `updateNote(userId: string, noteId: string, data: Partial<{ title: string; contentJson: string }>): Promise<Note | null>`
- `deleteNote(userId: string, noteId: string): Promise<void>`
- `setNotePublic(userId: string, noteId: string, isPublic: boolean): Promise<Note | null>`
- `getNoteByPublicSlug(slug: string): Promise<Note | null>`

Each function enforces `user_id = ?` in SQL where applicable, to avoid cross-user access.

## 7. API Design (Next.js Route Handlers)

Base path under `/api/notes`.

### 7.1 Authentication Access

Implement a server helper from better-auth like `getCurrentUser()` or `getSession()`.

All `/api/notes` handlers (except public read) must:

- Check auth
- Return 401 if not authenticated

### 7.2 Endpoints

#### GET /api/notes

**Description:** List notes for current user.

**Response 200:**

```json
[
  {
    "id": "note-id",
    "title": "My Note",
    "isPublic": true,
    "updatedAt": "2025-01-01T12:00:00Z"
  }
]
```

Optionally omit `contentJson` for list for performance.

#### POST /api/notes

**Description:** Create a new note.

**Request body (JSON):**

```json
{
  "title": "Optional title",
  "contentJson": { "type": "doc", ... }
}
```

**Behavior:**

- Default title = "Untitled note" if missing
- Default `contentJson` = empty TipTap document if missing

**Response 201:** created Note (or minimal subset)

#### GET /api/notes/:id

**Description:** Get single note owned by current user.

**Response:**

- 200 with full note including `contentJson`
- 404 if not found or not owned by user

#### PUT /api/notes/:id

**Description:** Update note title/content.

**Request body:**

```json
{
  "title": "New title",
  "contentJson": { ... }
}
```

**Response:**

- 200 with updated note
- 404 if not found

#### DELETE /api/notes/:id

**Description:** Delete note.

**Response:**

- 204 on success
- 404 if not found

#### POST /api/notes/:id/share

**Description:** Toggle public sharing.

**Request body:**

```json
{
  "isPublic": true
}
```

**Behavior:**

- If `isPublic = true` and note has no `public_slug`, generate new slug (`nanoid()`)
- If `isPublic = false`, set `is_public = 0` and `public_slug = NULL`

**Response 200:**

```json
{
  "id": "note-id",
  "isPublic": true,
  "publicSlug": "abcdef1234"
}
```

### 7.3 Public Note Endpoint

#### GET /api/public-notes/:slug

**Description:** Read-only access to public notes.

**Response 200:**

```json
{
  "title": "Public note",
  "contentJson": { ... }
}
```

- 404 if slug not found or `is_public = 0`

(Or skip this API and just resolve directly in the `/p/[slug]` route using server components.)

## 8. Frontend – Pages & Components

### 8.1 Routes

Assuming Next.js App Router structure:

- `/` – Landing page
  - Marketing / "Log in / Sign up" CTA
- `/dashboard` – Authenticated area
  - List of user notes
  - "Create note" button
- `/notes/[id]` – Authenticated note editor page
  - TipTap editor
  - Title field
  - Share toggle
  - Delete button
- `/p/[slug]` – Public note page
  - Read-only content
  - No nav to user-specific area if viewer is unauthenticated

### 8.2 Layout & Navigation

- Global layout: `app/layout.tsx`
  - Header with app name, login/logout/account & theme
- `app/(auth)/login`, `app/(auth)/register` (if better-auth doesn't provide their own UI)

### 8.3 Components

**components/NoteList.tsx**

- Props: `notes: { id, title, updatedAt, isPublic }[]`
- Renders list with links to `/notes/[id]`

**components/NoteEditor.tsx**

- TipTap-based editor
- Controlled by parent (`onChange` updates state, eventual API call)

**components/ShareToggle.tsx**

- Switch/checkbox for `isPublic`
- Shows public URL when enabled

**components/DeleteNoteButton.tsx**

- Confirms and calls DELETE API

**components/PublicNoteViewer.tsx**

- Render TipTap content in read-only mode (or use `EditorContent` with `editable: false`)

## 9. TipTap Integration

### 9.1 Extensions

Enable at minimum:

- `StarterKit` (with paragraphs, headings, bold, italic, bullet lists, horizontal rule, etc.)
- `Code` (inline code)
- `CodeBlockLowlight` or `CodeBlock` (for code snippets)

**Example editor config:**

```typescript
import { useEditor, EditorContent } from "@tiptap/react";
import StarterKit from "@tiptap/starter-kit";
import Code from "@tiptap/extension-code";
import CodeBlock from "@tiptap/extension-code-block";

const editor = useEditor({
  extensions: [
    StarterKit.configure({
      heading: { levels: [1, 2, 3] },
    }),
    Code,
    CodeBlock,
  ],
  content: initialContentJson, // TipTap JSON
  onUpdate: ({ editor }) => {
    const json = editor.getJSON();
    onChange(json);
  },
});
```

Content is always stored in DB as `JSON.stringify(json)`; when loading, `JSON.parse` and pass as `content`.

### 9.2 Toolbar

Buttons:

- Bold, Italic
- H1, H2, H3, paragraph
- Bullet list
- Inline code
- Code block
- Horizontal rule

Each button calls the relevant TipTap chain: `editor.chain().focus().toggleBold().run()` etc.

## 10. Styling (TailwindCSS)

- Configure Tailwind in `tailwind.config.ts`
- Use a minimal design:
  - Neutral background, card-like note container
  - Utility classes on components
- Consider a prose style for read-only content (using `@tailwindcss/typography`)

## 11. Security Considerations

**Auth enforcement**

- All `/dashboard` and `/notes/[id]` routes check auth on server
- API routes verify user and attach `userId` from session

**Authorization**

- Every note query in the auth context filters by `user_id`

**Public notes**

- Slug should be sufficiently random to prevent guessing (e.g. 16+ chars)

**XSS**

- Primary data is TipTap JSON, not raw HTML
- When rendering to HTML, only use TipTap's rendering (no arbitrary `dangerouslySetInnerHTML` with unsanitized data)

**Rate limiting (optional enhancement)**

- Apply per-IP or per-user rate limiting to API routes if exposed publicly

## 12. Development Workflow

1. **Initialize Next.js app** with Bun & TypeScript
2. **Set up TailwindCSS** for styling
3. **Integrate better-auth**
   - Install better-auth package
   - Configure auth instance with Bun SQLite database
   - Run `bun x @better-auth/cli@latest generate` to generate auth schema
   - Run `bun x @better-auth/cli@latest migrate` to create auth tables
4. **Set up database**
   - Create `notes` table (manually or via migration script)
   - Add indexes for performance
5. **Build DB helpers and note repository** (`lib/db.ts`, `lib/notes.ts`)
6. **Implement API routes**
   - `/api/notes` endpoints (CRUD operations)
   - `/api/notes/:id/share` for public sharing
   - `/api/public-notes/:slug` for public access (or use Server Components)
7. **Build UI pages**
   - Landing page (`/`)
   - Dashboard (`/dashboard`)
   - Note editor (`/notes/[id]`)
   - Public note viewer (`/p/[slug]`)
8. **Integrate TipTap editor**
   - Install TipTap packages
   - Create `NoteEditor` component with toolbar
   - Configure extensions (StarterKit, Code, CodeBlock)
9. **Add authentication UI**
   - Login/register pages
   - Session management
   - Protected routes middleware
10. **Add polish**
    - Loading states
    - Error handling
    - Toast notifications
    - Responsive design
